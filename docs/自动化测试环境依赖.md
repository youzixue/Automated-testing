## 自动化测试环境依赖与CI/CD集成操作文档（Jenkins+Linux+Docker最佳实践）

### 1. 环境准备
- 确保服务器已安装：
  - Python 3.11（建议不高于3.12）
  - Jenkins（推荐Docker部署，便于维护）
  - Docker（用于环境隔离和一致性）
  - Allure CLI（用于生成测试报告）
- 推荐使用Linux系统，便于自动化和权限管理。

### 2. 安装Poetry
```bash
pip install poetry
```
- 确保Poetry已添加到系统PATH。

### 3. 克隆项目仓库
```bash
git clone <项目仓库URL>
cd automated-testing
```

### 4. 使用Poetry安装依赖
```bash
poetry install
```

### 5. 环境变量与配置管理
- **本地开发**：复制`.env.example`为`.env`，根据实际需要修改。
- **CI环境**：
  - 不建议直接用`.env`，而是在Jenkins流水线或"构建参数"中**设置环境变量**，如：
    - `APP_ENV=prod` 或 `APP_ENV=test`
    - `WEB_BASE_URL=http://test.example.com/api/`
    - 其他敏感变量（如账号、密码、API密钥等）
  - Jenkins推荐用"凭据管理"安全注入敏感信息。

### 6. 安装浏览器驱动
```bash
poetry shell
playwright install
```

### 7. Jenkins流水线（Pipeline）配置示例

#### 7.1 推荐Jenkinsfile（Groovy语法）

```groovy
pipeline {
    agent any
    environment {
        APP_ENV = 'prod' // 或 'test'
        WEB_BASE_URL = 'https://cmpark.cmpo1914.com/'
        # 其他敏感变量...
    }
    stages {
        stage('Checkout') {
            steps {
                git credentialsId: 'your-jenkins-cred-id', url: 'git@gitlab.com:your/repo.git', branch: 'main'
            }
        }
        stage('Install dependencies') {
            steps {
                sh '''
                python3 -m venv venv
                . venv/bin/activate
                pip install -r requirements.txt
                '''
            }
        }
        stage('Install Browsers') {
            steps {
                sh '''
                . venv/bin/activate
                playwright install
                '''
            }
        }
        stage('Run tests') {
            steps {
                sh '''
                . venv/bin/activate
                pytest --alluredir=output/allure-results
                '''
            }
        }
        stage('Generate Allure Report') {
            steps {
                sh '''
                allure generate output/allure-results -o output/allure-report --clean
                '''
            }
        }
        stage('Archive Report') {
            steps {
                archiveArtifacts artifacts: 'output/allure-report/**', allowEmptyArchive: true
            }
        }
    }
    post {
        always {
            junit 'output/allure-results/*.xml'
        }
    }
}
```

#### 7.2 说明
- **环境变量**：所有敏感信息和环境切换均通过`environment`块或Jenkins凭据管理注入。
- **依赖隔离**：用venv或Docker，保证环境一致。
- **Allure报告**：自动生成并归档，便于团队查看。
- **安全**：敏感信息不落盘，全部用环境变量和凭据管理。

### 8. Allure CLI安装（Linux）
```bash
wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
tar -zxvf allure-2.27.0.tgz
sudo mv allure-2.27.0 /opt/allure
sudo ln -s /opt/allure/bin/allure /usr/bin/allure
allure --version
```

### 9. 本地/CI运行测试与生成报告
- 运行测试并生成Allure原始结果：
  ```bash
  pytest --alluredir=output/allure-results
  ```
- 生成HTML报告：
  ```bash
  allure generate output/allure-results -o output/allure-report --clean
  ```
- 本地查看报告：
  ```bash
  allure open output/allure-report
  ```

### 10. 敏感信息与多环境管理最佳实践
- 账号、密码、API密钥等敏感信息**只在Jenkins环境变量/凭据管理中维护**，不要写死在代码或.env文件。
- 切换环境只需改`APP_ENV`等变量，无需改动代码或配置文件。
- 推荐在README和团队文档中明确CI/CD环境变量和敏感信息管理规范。

### 11. 常见问题与建议
- **依赖冲突/缺失**：优先用venv或Docker隔离环境，避免全局包冲突。
- **Allure报告无法生成**：确认Allure CLI已正确安装，且pytest命令加了`--alluredir`参数。
- **环境变量未生效**：优先用Jenkins环境变量/凭据管理，不要依赖本地.env。
- **浏览器驱动未安装**：CI中需显式执行`playwright install`。
- **安全**：所有敏感信息用Jenkins凭据管理，绝不写入仓库。

---

如有特殊CI/CD平台（如GitLab CI、GitHub Actions等）或多环境并行测试需求，可参考本项目`docs/`目录下的其他集成文档或联系自动化负责人。

# 自动化测试环境依赖与CI/CD集成操作手册

> **如有环境/流程变更，请同步更新本手册，确保团队成员操作一致。**

## 目录结构与分层说明
本项目严格遵循七层架构设计，目录结构如下：

1. **测试用例层（tests/）**：自动化测试用例，按平台/业务分目录
2. **固件层（tests/conftest.py 等）**：pytest fixtures、全局前置后置、数据工厂
3. **业务对象层（src/web/pages/、src/api/services/、src/mobile/screens/）**：页面对象、服务对象、业务流程封装
4. **平台实现层（src/web/、src/api/、src/mobile/）**：平台相关实现与适配
5. **核心抽象层（src/core/base/）**：接口定义、抽象基类
6. **工具层（src/utils/）**：通用工具、OCR、日志、数据工厂等
7. **外部集成层（pyproject.toml）**：依赖声明与管理

> 详细分层与依赖关系请参见 docs/enhanced_architecture.md

---

## 1. 环境选择与准备
- 支持三种主流部署方式：
  1. 本地直装（适合个人开发/调试）
  2. Poetry虚拟环境（推荐，自动管理依赖）
  3. Docker容器化（推荐团队协作/CI/CD）
- 推荐使用华为云、阿里云、腾讯云等主流云厂商的Linux服务器（CentOS 7/8、Rocky Linux、Ubuntu 20.04+）。
- 建议选择最小化安装，避免多余软件干扰。
- 用Xshell、MobaXterm、FinalShell等工具，或直接用Windows/Linux自带的ssh命令连接服务器。

---

## 2. 安装基础依赖

### 2.1 安装Python 3.11+
- 检查Python版本：
  ```bash
  python3 --version
  ```
- 如未安装，推荐用源码安装或参考云厂商文档。
- 多版本共存建议用pyenv或指定python3.11执行后续命令。
- 激活正确版本：
  ```bash
  alias python=python3.11
  alias pip=pip3.11
  ```

### 2.2 安装Git（推荐用SSH方式拉代码）
- 检查是否已安装：
  ```bash
  git --version
  ```
- 推荐用SSH方式克隆代码，避免频繁输入用户名密码。
- 生成SSH密钥：
  ```bash
  ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
  cat ~/.ssh/id_rsa.pub
  ```
- 将公钥添加到Git服务器个人设置的SSH Key管理页面。

### 2.3 安装Poetry（依赖管理工具）
- 切换pip源为国内镜像（加速下载）：
  ```bash
  mkdir -p ~/.pip
  echo -e "[global]\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple" > ~/.pip/pip.conf
  ```
- 安装Poetry：
  ```bash
  pip install poetry
  ```
- 安装后可用`poetry --version`验证。
- **所有依赖必须通过`poetry add`/`poetry remove`管理，禁止直接修改pyproject.toml。依赖变更后需提交pyproject.toml和poetry.lock，并在PR描述中说明原因。**
- 如有多个Python版本，建议用如下命令指定虚拟环境Python版本：
  ```bash
  poetry env use python3.11
  ```

---

## 3. 克隆项目代码
- 选择存放目录，建议在/opt、~/workspace等目录下操作：
  ```bash
  cd /opt
  git clone git@<git服务器地址>:<group>/<repo>.git
  cd automated-testing
  ```

---

## 4. 安装项目依赖
- **必须在项目根目录下执行**：
  ```bash
  poetry install
  ```
- 安装完成后可用`poetry show`或`pip list`检查依赖包是否完整。
- 进入虚拟环境：
  ```bash
  poetry shell
  ```
- 也可用`poetry run pytest`等命令直接运行。

---

## 5. 配置环境变量与测试数据分离
- 本地开发：
  ```bash
  cp .env.example .env
  vim .env
  ```
  按需修改APP_ENV、WEB_BASE_URL等变量。
- **所有敏感信息全部用.env管理，实际值不得提交代码库。新增环境变量时，必须同步更新.env.example并补充注释说明。**
- **测试数据与测试逻辑分离，所有测试数据建议放在data/目录，结构和命名规范详见data/README.md，推荐YAML/JSON格式。**
- CI环境（Jenkins/GitHub Actions等）：
  - 不要直接用.env，推荐在流水线或"构建参数"中设置环境变量。
  - 敏感信息（如账号、密码、API密钥）用CI平台凭据管理。

---

## 6. Playwright浏览器驱动安装
- 进入虚拟环境并安装：
  ```bash
  poetry shell
  playwright install
  exit
  ```
- 如需安装特定浏览器：
  ```bash
  playwright install chromium
  playwright install firefox
  playwright install webkit
  ```
- 安装后可用`playwright --version`验证。
- 如遇playwright install下载慢，可设置代理或用国内镜像，详见Playwright官方文档。
- 如需无头模式，可在pytest参数中加`--headless`。

---

## 7. Allure CLI（测试报告工具）
- 下载并解压：
  ```bash
  cd /opt
  wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
  tar -zxvf allure-2.27.0.tgz
  sudo mv allure-2.27.0 /opt/allure
  sudo ln -s /opt/allure/bin/allure /usr/bin/allure
  allure --version
  ```
- Allure依赖Java 8+，如未安装请执行：
  ```bash
  yum install java-1.8.0-openjdk -y
  export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk
  export PATH=$JAVA_HOME/bin:$PATH
  ```
- output/allure-results和output/allure-report目录分别用于存放测试结果和HTML报告，output目录已在.gitignore中全局忽略，避免无用文件提交。

---

## 8. 运行自动化测试与报告生成
- 运行测试：
  ```bash
  poetry run pytest --alluredir=output/allure-results
  ```
- 推荐用`poetry run pytest`保证依赖环境一致，避免直接用`pytest`导致依赖找不到。
- 生成HTML报告：
  ```bash
  allure generate output/allure-results -o output/allure-report --clean
  ```
- 本地预览报告：
  ```bash
  allure open output/allure-report
  ```
- output目录下的allure-results、allure-report、logs、screenshots、coverage-data等均为临时/生成文件，已在.gitignore中全局忽略。

---

## 9. 测试数据分离与管理
- 所有测试数据应存放于data/目录，按业务/平台分子目录，推荐YAML/JSON格式。
- data/README.md中需说明各数据文件用途和字段含义。
- 新增/调整数据结构时，务必补充data/README.md。
- 测试数据与测试逻辑分离，便于维护和参数化。

---

## 10. CI/CD集成与敏感信息管理
- 所有代码变更必须通过CI/CD流程验证，确保代码质量和自动化测试执行。
- 推荐使用Jenkins、GitHub Actions等平台，参考@.github/workflows/test.yml。
- CI环境必须用poetry安装依赖，使用缓存加速。
- 测试环境与开发环境保持一致，Python版本3.11+。
- 敏感环境变量建议用CI平台凭据管理功能注入，避免写入代码或镜像。
- 参考Jenkinsfile和GitHub Actions示例，敏感信息不要明文写入流水线脚本。

---

## 11. Docker环境一键部署与CI/CD集成
- 推荐主机或CI流水线先拉取代码，再用Docker构建和运行测试环境。
- 不建议在Dockerfile中直接git clone代码，便于版本可控和CI集成。
- Dockerfile标准写法（项目根目录）：
  ```dockerfile
  FROM python:3.11-slim
  WORKDIR /app
  COPY . /app
  RUN pip install poetry \
      && poetry install \
      && pip install playwright \
      && playwright install
  CMD ["pytest", "--alluredir=output/allure-results"]
  ```
- 本地构建与运行：
  ```bash
  git clone <项目仓库URL>
  cd automated-testing
  docker build -t automated-testing:latest .
  docker run --rm -v $(pwd)/output:/app/output automated-testing:latest
  allure open output/allure-report
  ```
- CI脚本伪代码（以GitHub Actions为例）：
  ```yaml
  steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Build Docker image
      run: docker build -t automated-testing:latest .
    - name: Run tests
      run: docker run --rm -v ${{ github.workspace }}/output:/app/output automated-testing:latest
  ```
- output目录建议定期清理，节省磁盘空间。

---

## 12. 常见问题与团队协作建议
- pip/poetry下载慢：切换国内镜像源。
- yum/dnf不可用：用源码/二进制包或Docker安装工具。
- Allure报错找不到Java：需安装Java 8+，并设置JAVA_HOME。
- 权限问题：确保CI用户有写入Nginx目录权限。
- 环境变量未生效：优先用Jenkins/GitHub Actions环境变量/凭据管理。
- Playwright安装慢：可用代理或国内镜像。
- 依赖冲突、环境不一致：建议团队成员遇到问题及时沟通，统一在本手册和团队Wiki中记录最佳实践和常见问题。
- 每次环境/流程变更后，及时更新本操作文档，并在文档底部记录变更内容和日期。

---

## 13. 参考与扩展
- [Allure官方文档](https://docs.qameta.io/allure/)
- [Playwright官方文档](https://playwright.dev/python/)
- [Poetry官方文档](https://python-poetry.org/docs/)
- 团队内部Wiki/知识库（如有），持续收集最佳实践与常见问题，便于团队协作和持续改进。

---

如有任何步骤不明白、遇到报错或需要团队协作建议，请及时截图或复制报错内容，向团队或AI助手反馈，我们会第一时间协助你解决！

本手册适合零基础用户，建议每一步都严格按照文档执行。如有特殊需求或环境，请提前沟通。

---

### 变更记录
- 2024-06-XX：结构化重构，补充目录结构、环境变量、依赖管理、测试数据分离、CI/CD与Docker集成、常见问题等内容。

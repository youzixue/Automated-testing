# 环境变量配置规范

## 引言

环境变量是自动化测试框架中管理配置差异、保障敏感信息安全以及实现灵活部署的关键机制。本规范旨在统一环境变量的使用方式，确保配置的清晰性、安全性和可维护性，适用于开发、测试和生产等多种环境。

## 核心原则

1.  **配置分离**:
    *   **框架核心配置 (`config/settings.yaml`)**: 定义基础结构、通用默认值（如默认超时、日志格式）和与环境无关的设置。**不应**包含环境特定的URL、凭据或与特定UI强耦合的选择器。可使用 `${env:VAR_NAME:-default}` 提供默认值。
    *   **环境特定配置 (`config/env/*.yaml`)**: 定义特定环境的差异，如 `base_url`。通过 `${env:VAR_NAME}` 引用环境变量获取凭据、密钥等。
    *   **项目特定配置**: UI选择器、特定业务流开关等，应由使用框架的具体项目自行定义（如 `project_config.yaml`），框架提供加载机制。

2.  **敏感信息外部化**:
    *   **严禁**在代码或配置文件中硬编码密码、API密钥、Token等敏感信息。
    *   **必须**通过环境变量或安全的Secrets Management机制提供。

3.  **环境变量优先**:
    *   环境变量应具有最高优先级，能够覆盖所有配置文件中的同名设置。

## 文件职责

1.  **`.env.example`**:
    *   **作用**: 作为模板文件，列出框架和项目运行所需的**所有**环境变量名称。
    *   **内容**:
        *   包含变量名。
        *   提供**非敏感**的示例值或留空。
        *   使用**通用、描述性**的变量名（如 `TEST_ADMIN_USERNAME`, `WEB_BASE_URL`），避免与特定系统过度耦合。
    *   **版本控制**: **必须**提交到版本控制库。

    ```dotenv
    # .env.example 内容示例
    # -------------------------
    # Web 应用基础 URL
    WEB_BASE_URL=

    # API 基础 URL
    API_BASE_URL=

    # 测试环境管理员凭据
    TEST_ADMIN_USERNAME=
    TEST_ADMIN_PASSWORD=

    # 默认用户凭据 (根据环境自动选择 TEST_ 或 PROD_)
    DEFAULT_USERNAME=
    DEFAULT_PASSWORD=

    # 浏览器配置
    BROWSER=chromium
    HEADLESS=true
    DEFAULT_TIMEOUT=10

    # 日志级别 (DEBUG, INFO, WARNING, ERROR)
    LOG_LEVEL=INFO

    # 邮件通知 (可选)
    EMAIL_ENABLED=false
    EMAIL_SMTP_SERVER=
    EMAIL_SENDER=
    EMAIL_PASSWORD=
    EMAIL_RECIPIENTS=
    ```

2.  **`.env`**:
    *   **作用**: 存储**本地开发环境**的**实际**环境变量值，包括开发时使用的敏感信息。
    *   **内容**: 根据本地环境需要，覆盖 `.env.example` 中的变量值。
    *   **版本控制**: **绝不**提交到版本控制库，应将其添加到 `.gitignore` 文件中。

    ```dotenv
    # .env 文件内容示例 (本地)
    # --------------------------
    # 注意: 这个文件不应提交到 git
    WEB_BASE_URL=http://localhost:8080
    API_BASE_URL=http://localhost:3000/api

    TEST_ADMIN_USERNAME=local_admin
    TEST_ADMIN_PASSWORD=local_secret_password

    DEFAULT_USERNAME=${TEST_ADMIN_USERNAME} # 可以引用其他变量
    DEFAULT_PASSWORD=${TEST_ADMIN_PASSWORD}

    HEADLESS=false # 本地调试时可能需要关闭 headless
    LOG_LEVEL=DEBUG
    ```

3.  **`config/settings.yaml`**:
    *   如"核心原则"所述，定义框架的基础配置和通用默认值。
    ```yaml
    # config/settings.yaml 示例片段
    # -------------------------------
    web:
      output:
        directory: "output/web"
      timeouts:
        page_load: ${env:DEFAULT_TIMEOUT:-30} # 从环境变量获取，默认30秒
        element_wait: ${env:ELEMENT_WAIT_TIMEOUT:-5} # 默认5秒

    log:
      format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
      default_level: ${env:LOG_LEVEL:-INFO} # 从环境变量获取，默认INFO

    # 注意: 没有环境特定的 URL 或凭据
    ```

4.  **`config/env/*.yaml`** (例如: `test.yaml`, `prod.yaml`):
    *   如"核心原则"所述，定义特定环境的配置，并引用环境变量。
    ```yaml
    # config/env/test.yaml 示例片段
    # -----------------------------
    environment: test

    web:
      # 直接引用环境变量，不在 .env.example 中定义的也行
      base_url: "${env:WEB_BASE_URL}"
      # 可以覆盖 settings.yaml 中的默认值
      timeouts:
        page_load: 60 # 测试环境页面加载超时延长到60秒

    api:
      base_url: "${env:API_BASE_URL}"

    credentials:
      admin:
        username: "${env:TEST_ADMIN_USERNAME}"
        password: "${env:TEST_ADMIN_PASSWORD}"
      default:
        username: "${env:TEST_DEFAULT_USERNAME}"
        password: "${env:TEST_DEFAULT_PASSWORD}"

    log:
      # 测试环境日志级别可以更详细
      default_level: ${env:LOG_LEVEL:-DEBUG}
    ```

## 变量命名规范

*   **格式**: 使用大写字母和下划线 (`SNAKE_CASE`)。
*   **描述性**: 名称应清晰、准确地反映变量的用途（例如 `DATABASE_URL`, `API_KEY`）。
*   **通用性**: 优先使用通用的角色或概念名称（例如 `ADMIN_USERNAME`, `DEFAULT_PASSWORD`），而不是特定于某个系统的名称（例如避免 `OMP_PASSWORD`）。环境变量的具体值会根据部署环境的不同而变化。
*   **环境前缀 (可选)**: 对于少数确实需要在变量名中区分环境的场景，可以考虑使用前缀（例如 `PROD_API_KEY`, `TEST_DATABASE_URL`），但优先通过 `config/env/*.yaml` 结合通用变量名来管理。

    **示例:**
    *   **推荐**: `WEB_BASE_URL`, `ADMIN_USERNAME`, `API_REQUEST_TIMEOUT`, `EMAIL_SMTP_SERVER`
    *   **不推荐**: `url`, `admin`, `timeout`, `server` (过于模糊)
    *   **避免**: `OMP_URL`, `JIRA_PASS` (过于系统特定，除非框架强耦合该系统)
    *   **谨慎使用**: `PROD_DATABASE_URL`, `TEST_API_KEY` (仅在无法通过 `env/*.yaml` 管理时使用)

## 配置加载与优先级

*   **标准加载顺序**: 环境变量 > `.env` 文件 (如果框架加载) > `config/env/{environment}.yaml` > `config/settings.yaml`。
*   框架应实现一个明确的配置加载器，按此优先级顺序合并配置源。

    **示例: `web.base_url` 的值如何确定?**

    假设当前环境是 `test`，框架加载配置时：
    1.  **检查环境变量**: 是否直接设置了 `WEB_BASE_URL` 环境变量？
        *   是: 使用环境变量的值 (最高优先级)。例如 `export WEB_BASE_URL=https://staging.example.com`。
        *   否: 继续下一步。
    2.  **检查 `.env` 文件**: 本地是否存在 `.env` 文件且包含 `WEB_BASE_URL`？
        *   是: 使用 `.env` 文件中的值。例如 `WEB_BASE_URL=http://localhost:8080`。
        *   否: 继续下一步。
    3.  **检查 `config/env/test.yaml`**: 该文件中是否定义了 `web.base_url`？
        *   是: 使用 `test.yaml` 中的定义。该定义通常会引用环境变量 (`"${env:WEB_BASE_URL}"`)。如果此时对应的环境变量 (`WEB_BASE_URL`) 没有在步骤1或2中设置，则该配置项可能解析为空或导致错误（取决于配置库的处理方式）。
        *   否: 继续下一步。
    4.  **检查 `config/settings.yaml`**: 该文件中是否定义了 `web.base_url`？
        *   是: 使用 `settings.yaml` 中的值（通常不推荐在这里定义基础URL）。
        *   否: `web.base_url` 未定义。

## CI/CD 环境集成

*   在持续集成/持续部署 (CI/CD) 流水线中:
    *   **严禁**使用 `.env` 文件。
    *   环境变量应通过 CI/CD 平台提供的 **Secrets Management** 机制（如 GitHub Secrets, GitLab CI/CD Variables）安全地注入到执行环境中。

## 最佳实践

*   **保持同步**: 定期审查和更新 `.env.example` 文件，确保其反映了当前代码库所需的所有环境变量。
*   **文档一致**: 确保 `.env.example` 与项目文档（如 `README.md` 或本文件）中关于环境设置的说明保持一致。
*   **清晰指引**: 在项目 `README.md` 中提供清晰的指导，说明如何基于 `.env.example` 创建和配置本地的 `.env` 文件。

    **CI/CD 示例 (概念性)**
    *   在 GitHub Actions 中，可以在 Workflow 文件中使用 `env:` 块或 `secrets` 上下文来设置环境变量:
      ```yaml
      jobs:
        test:
          runs-on: ubuntu-latest
          steps:
            - name: Run tests
              env:
                WEB_BASE_URL: ${{ secrets.TEST_WEB_URL }} # 从 GitHub Secrets 获取
                TEST_ADMIN_USERNAME: ${{ secrets.TEST_ADMIN_USER }}
                TEST_ADMIN_PASSWORD: ${{ secrets.TEST_ADMIN_PASS }}
                LOG_LEVEL: INFO # 直接设置
              run: pytest tests/web/
      ```
    *   在 GitLab CI/CD 中，可以在 `.gitlab-ci.yml` 或项目设置中定义 CI/CD Variables。
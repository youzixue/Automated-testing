## 安装自动化测试框架环境依赖流程

### 1. 环境准备
- 确保安装Python 3.11（不高于3.12）
  - Windows/MacOS/Linux平台均支持
  - MacOS: `brew install python@3.11`
  - Windows: 从Python官网下载安装程序
  - Linux: 使用包管理工具（如apt、yum）

### 2. 安装Poetry
```bash
pip install poetry
```
- 确保Poetry已添加到系统路径中
- Windows可能需要重启终端或系统

### 3. 克隆项目仓库（根据情况，可选）
```bash
git clone <项目仓库URL>
cd automated-testing
```

### 4. 使用Poetry安装依赖
```bash
# 使用poetry安装所有依赖（包括开发依赖）
poetry install

# 如果仅需要运行测试，不需要开发依赖
poetry install --no-dev
```

### 5. 环境变量配置
- 复制示例环境变量文件作为本地配置
```bash
cp .env.example .env
```
- 根据实际需要修改.env文件中的配置，主要包括：
  - 浏览器配置（BROWSER、HEADLESS等）
  - 基础URL配置（WEB_BASE_URL、API_BASE_URL等）
  - 测试账号配置
  - 邮件配置（可选）
  - 日志配置

### 6. 安装浏览器驱动
```bash
# 激活Poetry虚拟环境
poetry shell

# 安装Playwright浏览器
playwright install

# 默认会安装Chromium、Firefox和WebKit
# 也可以指定安装特定浏览器
playwright install chromium
```

### 7. 验证环境
```bash
# 运行简单测试验证环境是否正确安装
pytest -v tests/web/test_login.py
```

### 工具链配置
- 代码格式检查：`black .`
- 静态代码分析：`pylint src tests`
- 类型检查：`mypy src`
- 安装pre-commit（可选）：`pre-commit install`

### 特定场景配置
- 移动测试：需要额外配置Android SDK或iOS开发环境
- 微信测试：参考docs/wxauto_setup.md进行wxauto环境配置

### 8. 安装Allure命令行工具（Allure CLI）

#### 8.1 本地开发环境安装

- **MacOS**  
  ```bash
  brew install allure
  ```
- **Windows**  
  ```bash
  scoop install allure
  ```
- **Linux（通用）**  
  ```bash
  wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
  tar -zxvf allure-2.27.0.tgz
  sudo mv allure-2.27.0 /opt/allure
  sudo ln -s /opt/allure/bin/allure /usr/bin/allure
  allure --version
  ```

#### 8.2 CI环境安装（以GitHub Actions为例）

```yaml
- name: Install Allure CLI
  run: |
    sudo apt-get update
    sudo apt-get install -y default-jre
    wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
    tar -zxvf allure-2.27.0.tgz
    sudo mv allure-2.27.0 /opt/allure
    sudo ln -s /opt/allure/bin/allure /usr/bin/allure
    allure --version
```

#### 8.3 GitLab CI环境安装与报告归档

- 在`.gitlab-ci.yml`中，推荐如下方式自动安装Allure CLI并归档报告：

```yaml
stages:
  - test
  - report

variables:
  ALLURE_VERSION: "2.27.0"

before_script:
  - apt-get update && apt-get install -y default-jre wget
  - wget https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.tgz
  - tar -zxvf allure-${ALLURE_VERSION}.tgz
  - mv allure-${ALLURE_VERSION} /opt/allure
  - ln -s /opt/allure/bin/allure /usr/bin/allure
  - allure --version

test:
  stage: test
  script:
    - poetry install
    - pytest --alluredir=allure-results
  artifacts:
    paths:
      - allure-results/
    expire_in: 1 week

allure_report:
  stage: report
  script:
    - allure generate allure-results -o allure-report --clean
  dependencies:
    - test
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
```

- **说明与注意事项：**
  - 推荐将Allure CLI安装步骤放在before_script，保证所有stage都可用。
  - 测试阶段产出allure-results，报告阶段生成HTML并归档。
  - 所有敏感信息（如Jenkins Token）请用GitLab CI/CD变量管理。
  - 建议所有报告、日志都通过artifact归档，便于团队成员下载和历史追溯。

#### 8.4 生成和查看Allure报告

- 运行测试并生成Allure结果目录：
  ```bash
  pytest --alluredir=allure-results
  ```
- 生成HTML报告：
  ```bash
  allure generate allure-results -o allure-report --clean
  ```
- 本地查看报告：
  ```bash
  allure serve allure-results
  ```

#### 8.5 常见问题与注意事项

- **未安装Allure CLI时无法生成HTML报告。**
- **CI环境必须自动安装Allure CLI，不能只依赖本地。**
- **建议将allure-report作为artifact归档，便于团队成员下载和历史追溯。**
- **仅安装allure-pytest插件不能生成HTML报告，必须有Allure CLI。**

以上步骤完成后，自动化测试框架的完整环境就已经准备就绪，可以开始进行测试开发和执行了。
